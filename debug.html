<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIME è°ƒè¯•é¡µé¢</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        label {
            display: block;
            color: #555;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        .input-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
        }
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .candidates-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .candidate-item {
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .candidate-item:hover {
            background: #667eea;
            color: white;
        }
        .candidate-item.selected {
            background: #764ba2;
            color: white;
            border-color: #667eea;
        }
        .candidate-word {
            font-weight: 600;
        }
        .candidate-pinyin {
            font-size: 12px;
            opacity: 0.7;
            margin-left: 4px;
        }
        .candidate-score {
            font-size: 11px;
            opacity: 0.5;
            margin-left: 4px;
        }
        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result-box pre {
            white-space: pre-wrap;
            word-break: break-all;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #333;
        }
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin-top: 12px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        .context-display {
            background: #e8f4f8;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 18px;
            min-height: 50px;
            color: #333;
        }
        .preedit {
            color: #667eea;
            font-style: italic;
        }
        .tips {
            font-size: 13px;
            color: #888;
            margin-top: 8px;
        }
        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 12px;
        }
        .tab-btn {
            padding: 8px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: #e0e0e0;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
        }
        .code-preview {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-x: auto;
        }
        .response-meta {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .meta-item {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
        }
        .meta-status {
            background: #d4edda;
            color: #155724;
        }
        .meta-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .meta-time {
            background: #e2e3e5;
            color: #383d41;
        }
        .meta-method {
            background: #cce5ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ LIME è°ƒè¯•é¡µé¢</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="card">
            <h2>âš™ï¸ é…ç½®</h2>
            <div class="input-row">
                <div class="form-group">
                    <label>æœåŠ¡å™¨åœ°å€</label>
                    <input type="text" id="serverUrl" value="http://127.0.0.1:5001" placeholder="http://127.0.0.1:5001">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API Key">
                </div>
                <button class="btn-secondary" onclick="toggleKeyVisibility()">ğŸ‘ï¸</button>
            </div>
            <p class="tips">ğŸ’¡ API Key ä¼šä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</p>
        </div>

        <!-- è¾“å…¥æµ‹è¯•åŒºåŸŸ -->
        <div class="card">
            <h2>âŒ¨ï¸ æ‹¼éŸ³è¾“å…¥æµ‹è¯•</h2>
            <div class="form-group">
                <label>è¾“å…¥æ‹¼éŸ³ï¼ˆå¦‚ï¼šnihaoshijieï¼‰</label>
                <input type="text" id="pinyinInput" placeholder="è¾“å…¥æ‹¼éŸ³å­—æ¯..." oninput="onPinyinInput()">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="getCandidates()">è·å–å€™é€‰è¯</button>
                <button class="btn-secondary" onclick="clearInput()">æ¸…ç©º</button>
            </div>
            
            <div id="statusArea"></div>
            
            <!-- å€™é€‰è¯å±•ç¤º -->
            <div id="candidatesArea" style="display:none;">
                <h3 style="margin-top:16px; color:#333;">å€™é€‰è¯ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</h3>
                <div class="candidates-list" id="candidatesList"></div>
            </div>
        </div>

        <!-- ä¸Šä¸‹æ–‡åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ“ å·²è¾“å…¥æ–‡å­—ï¼ˆä¸Šä¸‹æ–‡ï¼‰</h2>
            <div class="context-display" id="contextDisplay">
                <span id="committedText"></span>
                <span class="preedit" id="preeditText"></span>
            </div>
            <div class="button-group">
                <button class="btn-success" onclick="commitSelected()">æäº¤é€‰ä¸­è¯</button>
                <button class="btn-secondary" onclick="clearContext()">æ¸…ç©ºä¸Šä¸‹æ–‡</button>
            </div>
        </div>

        <!-- API æµ‹è¯•åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ”§ API æ¥å£æµ‹è¯•</h2>
            
            <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('candidates')">candidates</button>
                <button class="tab-btn" onclick="switchTab('commit')">commit</button>
                <button class="tab-btn" onclick="switchTab('userdata')">userdata</button>
            </div>

            <!-- candidates æ¥å£æµ‹è¯• -->
            <div id="tab-candidates" class="tab-content active">
                <div class="form-group">
                    <label>è¯·æ±‚æ–¹å¼</label>
                    <select id="candidatesMethod" onchange="updateCandidatesPreview()">
                        <option value="POST">POST</option>
                        <option value="GET">GET</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>keys å‚æ•°</label>
                    <input type="text" id="candidatesKeys" placeholder="nihaoshijie" oninput="updateCandidatesPreview()">
                </div>
                <div class="form-group">
                    <label>è¯·æ±‚é¢„è§ˆ</label>
                    <div class="code-preview" id="candidatesPreview"></div>
                </div>
                <button class="btn-primary" onclick="testCandidates()">å‘é€è¯·æ±‚</button>
            </div>

            <!-- commit æ¥å£æµ‹è¯• -->
            <div id="tab-commit" class="tab-content">
                <div class="form-group">
                    <label>è¯·æ±‚æ–¹å¼</label>
                    <select id="commitMethod" onchange="updateCommitPreview()">
                        <option value="POST">POST</option>
                        <option value="GET">GET</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>text å‚æ•°ï¼ˆå¿…å¡«ï¼‰</label>
                    <input type="text" id="commitText" placeholder="ä½ å¥½ä¸–ç•Œ" oninput="updateCommitPreview()">
                </div>
                <div class="form-group">
                    <label>new å‚æ•°ï¼ˆæ˜¯å¦æ–°ä¸Šä¸‹æ–‡ï¼Œé»˜è®¤ trueï¼‰</label>
                    <select id="commitNew" onchange="updateCommitPreview()">
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>update å‚æ•°ï¼ˆæ˜¯å¦æ›´æ–°ï¼Œé»˜è®¤ falseï¼‰</label>
                    <select id="commitUpdate" onchange="updateCommitPreview()">
                        <option value="false">false</option>
                        <option value="true">true</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¯·æ±‚é¢„è§ˆ</label>
                    <div class="code-preview" id="commitPreview"></div>
                </div>
                <button class="btn-success" onclick="testCommit()">å‘é€è¯·æ±‚</button>
            </div>

            <!-- userdata æ¥å£æµ‹è¯• -->
            <div id="tab-userdata" class="tab-content">
                <p class="tips">è·å–å½“å‰ç”¨æˆ·æ•°æ®ï¼ˆä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰</p>
                <div class="form-group">
                    <label>è¯·æ±‚é¢„è§ˆ</label>
                    <div class="code-preview">GET /userdata</div>
                </div>
                <button class="btn-primary" onclick="testUserdata()">è·å–ç”¨æˆ·æ•°æ®</button>
            </div>
        </div>

        <!-- åŸå§‹å“åº”åŒºåŸŸ -->
        <div class="card">
            <h2>ğŸ“‹ åŸå§‹ API å“åº”</h2>
            <div class="response-meta" id="responseMeta"></div>
            <div class="result-box">
                <pre id="rawResponse">ç­‰å¾…è¯·æ±‚...</pre>
            </div>
        </div>

        <!-- curl å‘½ä»¤ç”Ÿæˆ -->
        <div class="card">
            <h2>ğŸ“ curl å‘½ä»¤</h2>
            <p class="tips">å¤åˆ¶æ­¤å‘½ä»¤å¯åœ¨ç»ˆç«¯ä¸­æµ‹è¯•</p>
            <div class="result-box">
                <pre id="curlCommand">é€‰æ‹©æ¥å£åè‡ªåŠ¨ç”Ÿæˆ...</pre>
            </div>
            <button class="btn-secondary" onclick="copyCurl()">å¤åˆ¶å‘½ä»¤</button>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        let currentCandidates = [];
        let selectedCandidate = null;
        let committedText = '';

        // é¡µé¢åŠ è½½æ—¶æ¢å¤é…ç½®
        window.onload = function() {
            const savedKey = localStorage.getItem('lime_api_key');
            const savedUrl = localStorage.getItem('lime_server_url');
            if (savedKey) document.getElementById('apiKey').value = savedKey;
            if (savedUrl) document.getElementById('serverUrl').value = savedUrl;
        };

        // ä¿å­˜é…ç½®
        function saveConfig() {
            localStorage.setItem('lime_api_key', document.getElementById('apiKey').value);
            localStorage.setItem('lime_server_url', document.getElementById('serverUrl').value);
        }

        // åˆ‡æ¢å¯†é’¥å¯è§æ€§
        function toggleKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type) {
            const area = document.getElementById('statusArea');
            area.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // æ‹¼éŸ³è¾“å…¥æ—¶è‡ªåŠ¨è·å–å€™é€‰è¯
        let inputTimer = null;
        function onPinyinInput() {
            clearTimeout(inputTimer);
            const input = document.getElementById('pinyinInput').value;
            document.getElementById('preeditText').textContent = input;
            
            if (input.length > 0) {
                inputTimer = setTimeout(getCandidates, 300);
            } else {
                document.getElementById('candidatesArea').style.display = 'none';
            }
        }

        // è·å–å€™é€‰è¯
        async function getCandidates() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const keys = document.getElementById('pinyinInput').value;

            if (!keys) {
                showStatus('è¯·è¾“å…¥æ‹¼éŸ³', 'error');
                return;
            }

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            saveConfig();
            showStatus('è¯·æ±‚ä¸­...', 'loading');

            try {
                const response = await fetch(`${serverUrl}/candidates`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({ keys })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    showStatus(`é”™è¯¯: ${response.status} - ${data.message || 'è¯·æ±‚å¤±è´¥'}`, 'error');
                    document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
                    return;
                }

                currentCandidates = data.candidates || [];
                showStatus(`æˆåŠŸè·å– ${currentCandidates.length} ä¸ªå€™é€‰è¯`, 'success');
                renderCandidates();
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('rawResponse').textContent = error.toString();
            }
        }

        // æ¸²æŸ“å€™é€‰è¯åˆ—è¡¨
        function renderCandidates() {
            const list = document.getElementById('candidatesList');
            const area = document.getElementById('candidatesArea');
            
            if (currentCandidates.length === 0) {
                area.style.display = 'none';
                return;
            }

            area.style.display = 'block';
            list.innerHTML = currentCandidates.map((c, i) => `
                <div class="candidate-item ${selectedCandidate === i ? 'selected' : ''}" 
                     onclick="selectCandidate(${i})">
                    <span class="candidate-word">${c.word}</span>
                    <span class="candidate-pinyin">[${c.pinyin.join(' ')}]</span>
                    <span class="candidate-score">${(c.score * 100).toFixed(2)}%</span>
                </div>
            `).join('');
        }

        // é€‰æ‹©å€™é€‰è¯
        function selectCandidate(index) {
            selectedCandidate = index;
            renderCandidates();
        }

        // æäº¤é€‰ä¸­çš„è¯
        async function commitSelected() {
            if (selectedCandidate === null || !currentCandidates[selectedCandidate]) {
                showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå€™é€‰è¯', 'error');
                return;
            }

            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const candidate = currentCandidates[selectedCandidate];
            const text = candidate.word;

            try {
                const response = await fetch(`${serverUrl}/commit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({ text })
                });

                const data = await response.json();

                if (response.ok) {
                    committedText += text;
                    document.getElementById('committedText').textContent = committedText;
                    
                    // å¦‚æœæœ‰å‰©ä½™æ‹¼éŸ³ï¼Œç»§ç»­è¾“å…¥
                    if (candidate.remainkeys && candidate.remainkeys.length > 0) {
                        document.getElementById('pinyinInput').value = candidate.remainkeys.join('');
                        onPinyinInput();
                    } else {
                        document.getElementById('pinyinInput').value = '';
                        document.getElementById('preeditText').textContent = '';
                        document.getElementById('candidatesArea').style.display = 'none';
                    }
                    
                    selectedCandidate = null;
                    showStatus(`å·²æäº¤: ${text}`, 'success');
                } else {
                    showStatus(`æäº¤å¤±è´¥: ${data.message}`, 'error');
                }

                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                showStatus(`æäº¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('pinyinInput').value = '';
            document.getElementById('preeditText').textContent = '';
            document.getElementById('candidatesArea').style.display = 'none';
            document.getElementById('statusArea').innerHTML = '';
            currentCandidates = [];
            selectedCandidate = null;
        }

        // æ¸…ç©ºä¸Šä¸‹æ–‡
        function clearContext() {
            committedText = '';
            document.getElementById('committedText').textContent = '';
            showStatus('ä¸Šä¸‹æ–‡å·²æ¸…ç©º', 'success');
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // æ•°å­—é”®é€‰æ‹©å€™é€‰è¯
            if (e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                if (index < currentCandidates.length) {
                    selectCandidate(index);
                }
            }
            // ç©ºæ ¼æäº¤
            if (e.key === ' ' && selectedCandidate !== null) {
                e.preventDefault();
                commitSelected();
            }
            // Enter è·å–å€™é€‰è¯
            if (e.key === 'Enter' && document.activeElement.id === 'pinyinInput') {
                getCandidates();
            }
        });

        // ========== API æµ‹è¯•åŠŸèƒ½ ==========

        let currentCurl = '';

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // æ›´æ–°é¢„è§ˆ
            if (tabName === 'candidates') updateCandidatesPreview();
            else if (tabName === 'commit') updateCommitPreview();
            else if (tabName === 'userdata') updateUserdataPreview();
        }

        // æ›´æ–° candidates è¯·æ±‚é¢„è§ˆ
        function updateCandidatesPreview() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const method = document.getElementById('candidatesMethod').value;
            const keys = document.getElementById('candidatesKeys').value || 'nihaoshijie';

            let preview = '';
            let curl = '';

            if (method === 'POST') {
                preview = `POST /candidates\n\nHeaders:\n  Content-Type: application/json\n  Authorization: Bearer ${apiKey || '<your-key>'}\n\nBody:\n${JSON.stringify({ keys }, null, 2)}`;
                curl = `curl --request POST \\\n  --url ${serverUrl}/candidates \\\n  --header 'content-type: application/json' \\\n  --header 'Authorization: Bearer ${apiKey || '<your-key>'}' \\\n  --data '${JSON.stringify({ keys })}'`;
            } else {
                preview = `GET /candidates?keys=${encodeURIComponent(keys)}\n\nHeaders:\n  Authorization: Bearer ${apiKey || '<your-key>'}`;
                curl = `curl --request GET \\\n  --url "${serverUrl}/candidates?keys=${encodeURIComponent(keys)}" \\\n  --header 'Authorization: Bearer ${apiKey || '<your-key>'}'`;
            }

            document.getElementById('candidatesPreview').textContent = preview;
            document.getElementById('curlCommand').textContent = curl;
            currentCurl = curl;
        }

        // æ›´æ–° commit è¯·æ±‚é¢„è§ˆ
        function updateCommitPreview() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const method = document.getElementById('commitMethod').value;
            const text = document.getElementById('commitText').value || 'ä½ å¥½ä¸–ç•Œ';
            const isNew = document.getElementById('commitNew').value === 'true';
            const update = document.getElementById('commitUpdate').value === 'true';

            let preview = '';
            let curl = '';

            if (method === 'POST') {
                const body = { text, new: isNew, update };
                preview = `POST /commit\n\nHeaders:\n  Content-Type: application/json\n  Authorization: Bearer ${apiKey || '<your-key>'}\n\nBody:\n${JSON.stringify(body, null, 2)}`;
                curl = `curl --request POST \\\n  --url ${serverUrl}/commit \\\n  --header 'content-type: application/json' \\\n  --header 'Authorization: Bearer ${apiKey || '<your-key>'}' \\\n  --data '${JSON.stringify(body)}'`;
            } else {
                const params = new URLSearchParams({ text, new: isNew, update });
                preview = `GET /commit?${params}\n\nHeaders:\n  Authorization: Bearer ${apiKey || '<your-key>'}`;
                curl = `curl --request GET \\\n  --url "${serverUrl}/commit?${params}" \\\n  --header 'Authorization: Bearer ${apiKey || '<your-key>'}'`;
            }

            document.getElementById('commitPreview').textContent = preview;
            document.getElementById('curlCommand').textContent = curl;
            currentCurl = curl;
        }

        // æ›´æ–° userdata è¯·æ±‚é¢„è§ˆ
        function updateUserdataPreview() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const curl = `curl --request GET \\\n  --url ${serverUrl}/userdata \\\n  --header 'Authorization: Bearer ${apiKey || '<your-key>'}'`;
            document.getElementById('curlCommand').textContent = curl;
            currentCurl = curl;
        }

        // æ˜¾ç¤ºå“åº”å…ƒä¿¡æ¯
        function showResponseMeta(status, time, method) {
            const meta = document.getElementById('responseMeta');
            const statusClass = status >= 200 && status < 300 ? '' : 'error';
            meta.innerHTML = `
                <span class="meta-item meta-method">${method}</span>
                <span class="meta-item meta-status ${statusClass}">çŠ¶æ€: ${status}</span>
                <span class="meta-item meta-time">è€—æ—¶: ${time}ms</span>
            `;
        }

        // æµ‹è¯• candidates æ¥å£
        async function testCandidates() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const method = document.getElementById('candidatesMethod').value;
            const keys = document.getElementById('candidatesKeys').value || 'nihaoshijie';

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            saveConfig();
            const startTime = Date.now();

            try {
                let response;
                if (method === 'POST') {
                    response = await fetch(`${serverUrl}/candidates`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({ keys })
                    });
                } else {
                    response = await fetch(`${serverUrl}/candidates?keys=${encodeURIComponent(keys)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                }

                const data = await response.json();
                const endTime = Date.now();
                
                showResponseMeta(response.status, endTime - startTime, method);
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
                showStatus(`è¯·æ±‚å®Œæˆ: ${response.status}`, response.ok ? 'success' : 'error');

            } catch (error) {
                showResponseMeta('Error', Date.now() - startTime, method);
                document.getElementById('rawResponse').textContent = error.toString();
                showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯• commit æ¥å£
        async function testCommit() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const method = document.getElementById('commitMethod').value;
            const text = document.getElementById('commitText').value;
            const isNew = document.getElementById('commitNew').value === 'true';
            const update = document.getElementById('commitUpdate').value === 'true';

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            if (!text) {
                showStatus('è¯·è¾“å…¥ text å‚æ•°', 'error');
                return;
            }

            saveConfig();
            const startTime = Date.now();

            try {
                let response;
                if (method === 'POST') {
                    response = await fetch(`${serverUrl}/commit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({ text, new: isNew, update })
                    });
                } else {
                    const params = new URLSearchParams({ text, new: isNew, update });
                    response = await fetch(`${serverUrl}/commit?${params}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                }

                const data = await response.json();
                const endTime = Date.now();
                
                showResponseMeta(response.status, endTime - startTime, method);
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
                showStatus(`è¯·æ±‚å®Œæˆ: ${response.status}`, response.ok ? 'success' : 'error');

            } catch (error) {
                showResponseMeta('Error', Date.now() - startTime, method);
                document.getElementById('rawResponse').textContent = error.toString();
                showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯• userdata æ¥å£
        async function testUserdata() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;

            if (!apiKey) {
                showStatus('è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            saveConfig();
            const startTime = Date.now();

            try {
                const response = await fetch(`${serverUrl}/userdata`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });

                const data = await response.json();
                const endTime = Date.now();
                
                showResponseMeta(response.status, endTime - startTime, 'GET');
                document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
                showStatus(`è¯·æ±‚å®Œæˆ: ${response.status}`, response.ok ? 'success' : 'error');

            } catch (error) {
                showResponseMeta('Error', Date.now() - startTime, 'GET');
                document.getElementById('rawResponse').textContent = error.toString();
                showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¤åˆ¶ curl å‘½ä»¤
        function copyCurl() {
            navigator.clipboard.writeText(currentCurl).then(() => {
                showStatus('curl å‘½ä»¤å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                showStatus('å¤åˆ¶å¤±è´¥: ' + err.message, 'error');
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é¢„è§ˆ
        setTimeout(() => {
            updateCandidatesPreview();
        }, 100);
    </script>
</body>
</html>
